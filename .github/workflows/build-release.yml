name: Build and Release Connected

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: windows-2022
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest
    
    - name: Run tests
      run: |
        # pytest tests/ (ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆ)
        python -c "print('ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ— - ä»Šå¾Œå®Ÿè£…äºˆå®š')"

  build:
    needs: test
    runs-on: windows-2022
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller pywin32
    
    - name: Build executable with PyInstaller
      run: |
        pyinstaller Connected.spec
    
    - name: Create release archive
      run: |
        New-Item -ItemType Directory -Force -Path release
        Copy-Item dist\Connected.exe release\
        Copy-Item README.md release\
        Copy-Item LICENSE release\
        "Connected v${{ github.ref_name }} - Windows 11 Bluetooth Battery Monitor" | Out-File -FilePath release\README.txt -Encoding UTF8
        "" | Out-File -FilePath release\README.txt -Append -Encoding UTF8
        "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•:" | Out-File -FilePath release\README.txt -Append -Encoding UTF8
        "1. Connected.exe ã‚’ãŠå¥½ã¿ã®å ´æ‰€ï¼ˆä¾‹ï¼šC:\Program Files\Connected\ï¼‰ã«ã‚³ãƒ”ãƒ¼" | Out-File -FilePath release\README.txt -Append -Encoding UTF8
        "2. Connected.exe ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦èµ·å‹•" | Out-File -FilePath release\README.txt -Append -Encoding UTF8
        "3. åˆå›èµ·å‹•æ™‚ã«Windowsã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆã¯ã€Œè©³ç´°æƒ…å ±ã€â†’ã€Œå®Ÿè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯" | Out-File -FilePath release\README.txt -Append -Encoding UTF8
        "4. ã‚·ã‚¹ãƒ†ãƒ ãƒˆãƒ¬ã‚¤ã«ã‚¢ã‚¤ã‚³ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™" | Out-File -FilePath release\README.txt -Append -Encoding UTF8
        "" | Out-File -FilePath release\README.txt -Append -Encoding UTF8
        "ä½¿ç”¨æ–¹æ³•:" | Out-File -FilePath release\README.txt -Append -Encoding UTF8
        "- ã‚·ã‚¹ãƒ†ãƒ ãƒˆãƒ¬ã‚¤ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§è¡¨ç¤º" | Out-File -FilePath release\README.txt -Append -Encoding UTF8
        "- ãƒ¡ã‚¤ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§Bluetoothãƒ‡ãƒã‚¤ã‚¹ã®ãƒãƒƒãƒ†ãƒªãƒ¼æ®‹é‡ã‚’ç¢ºèª" | Out-File -FilePath release\README.txt -Append -Encoding UTF8
        "- ãƒãƒƒãƒ†ãƒªãƒ¼æ®‹é‡ãŒä½ä¸‹ã™ã‚‹ã¨è‡ªå‹•é€šçŸ¥" | Out-File -FilePath release\README.txt -Append -Encoding UTF8
        
    - name: Upload release files
      uses: actions/upload-artifact@v4
      with:
        name: Connected-${{ github.ref_name }}-Windows
        path: release/

  release:
    needs: build
    runs-on: windows-2022
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download release files
      uses: actions/download-artifact@v4
      with:
        name: Connected-${{ github.ref_name }}-Windows
        path: release/
    
    - name: Create ZIP archive
      run: |
        Compress-Archive -Path release\* -DestinationPath Connected-${{ github.ref_name }}-Windows.zip
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Connected ${{ github.ref_name }}
        body: |
          ## Connected ${{ github.ref_name }} - Windows 11 Bluetooth Battery Monitor
          
          ### ğŸ‰ æ–°æ©Ÿèƒ½ãƒ»æ”¹å–„ç‚¹
          - Bluetoothãƒ‡ãƒã‚¤ã‚¹ã®ãƒãƒƒãƒ†ãƒªãƒ¼æ®‹é‡ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
          - ãƒ¢ãƒ€ãƒ³ãªãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒUI
          - ã‚·ã‚¹ãƒ†ãƒ ãƒˆãƒ¬ã‚¤å¸¸é§æ©Ÿèƒ½
          - ä½ãƒãƒƒãƒ†ãƒªãƒ¼è‡ªå‹•é€šçŸ¥
          
          ### ğŸ“‹ ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶
          - Windows 11 (Windows 10ã§ã‚‚å‹•ä½œã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™)
          - Bluetoothã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼
          - å¯¾å¿œBluetoothãƒ‡ãƒã‚¤ã‚¹ï¼ˆãƒ˜ãƒƒãƒ‰ãƒ›ãƒ³ã€ãƒã‚¦ã‚¹ã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãªã©ï¼‰
          
          ### ğŸš€ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
          1. `Connected-${{ github.ref_name }}-Windows.zip` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£å‡
          3. `Connected.exe` ã‚’ãŠå¥½ã¿ã®å ´æ‰€ã«ã‚³ãƒ”ãƒ¼
          4. `Connected.exe` ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦èµ·å‹•
          
          ### ğŸ’¡ ä½¿ç”¨æ–¹æ³•
          - ã‚·ã‚¹ãƒ†ãƒ ãƒˆãƒ¬ã‚¤ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º
          - Bluetoothãƒ‡ãƒã‚¤ã‚¹ã®ãƒãƒƒãƒ†ãƒªãƒ¼æ®‹é‡ãŒä¸€è¦§è¡¨ç¤ºã•ã‚Œã¾ã™
          - ãƒãƒƒãƒ†ãƒªãƒ¼æ®‹é‡ãŒ10%ä»¥ä¸‹ã«ãªã‚‹ã¨è‡ªå‹•é€šçŸ¥
          
          ### ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
          - åˆå›èµ·å‹•æ™‚ã«Windowsã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆã¯ã€Œè©³ç´°æƒ…å ±ã€â†’ã€Œå®Ÿè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯
          - ãƒ‡ãƒã‚¤ã‚¹ãŒæ¤œå‡ºã•ã‚Œãªã„å ´åˆã¯ã€Bluetoothè¨­å®šã§ãƒ‡ãƒã‚¤ã‚¹ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          
          ---
          
          â­ ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå½¹ã«ç«‹ã£ãŸå ´åˆã¯ã€GitHubã§ã‚¹ã‚¿ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼
          ğŸ› ãƒã‚°å ±å‘Šã‚„æ©Ÿèƒ½è¦æœ›ã¯ [Issues](https://github.com/${{ github.repository }}/issues) ã§ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚
        files: |
          Connected-${{ github.ref_name }}-Windows.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
